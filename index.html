<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Field Accounting System üìí‚ú®</title>
  <style>
    :root{
      --bg:#fff7fb;
      --card:#ffffff;
      --ink:#1f1f27;
      --muted:#6a6a78;
      --line:#ece7f2;
      --accent:#ff5fa2;
      --accent2:#7c5cff;
      --good:#1aa86f;
      --bad:#e34a4a;
      --warn:#f2a100;
      --shadow: 0 10px 30px rgba(20, 10, 30, .08);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(255,95,162,.14), transparent 60%),
        radial-gradient(1000px 500px at 90% 20%, rgba(124,92,255,.14), transparent 55%),
        radial-gradient(800px 400px at 50% 95%, rgba(26,168,111,.10), transparent 60%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: rgba(255,247,251,.75);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 90px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:8px 0 10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(255,95,162,.95), rgba(124,92,255,.95));
      box-shadow: var(--shadow);
      display:grid;place-items:center;
      color:white;font-size:22px;
      flex:0 0 auto;
    }
    .title{display:flex;flex-direction:column;min-width:0}
    .title b{font-size:15px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .title span{font-size:12px;color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .tabs{
      display:flex; gap:10px;
      padding:0 0 10px;
    }
    .tab{
      flex:1;
      border:1px solid var(--line);
      background: rgba(255,255,255,.7);
      border-radius: 999px;
      padding:10px 12px;
      font-weight:700;
      display:flex;align-items:center;justify-content:center;gap:8px;
      box-shadow: 0 6px 16px rgba(20,10,30,.06);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(255,95,162,.45);
      background: linear-gradient(135deg, rgba(255,95,162,.12), rgba(124,92,255,.10));
      box-shadow: 0 10px 25px rgba(255,95,162,.10);
    }
    .pill{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(124,92,255,.12);
      color: #3f2bb6;
      border:1px solid rgba(124,92,255,.20);
      font-weight:800;
      white-space:nowrap;
    }
    .row{display:grid;gap:14px}
    @media (min-width:920px){
      .row.two{grid-template-columns: 1.05fr .95fr;}
      .row.three{grid-template-columns: 1.1fr .9fr .9fr;}
    }
    .card{
      background: rgba(255,255,255,.86);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      display:flex;align-items:center;justify-content:space-between;gap:8px;
    }
    .sub{color:var(--muted);font-size:12px;margin-top:-6px;margin-bottom:10px}
    .grid{display:grid;gap:10px}
    .grid.cols2{grid-template-columns: 1fr 1fr}
    .grid.cols3{grid-template-columns: 1fr 1fr 1fr}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.95);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:84px;resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,95,162,.55);
      box-shadow: 0 0 0 4px rgba(255,95,162,.12);
    }
    .btnrow{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{
      border:none;
      padding:10px 12px;
      border-radius: 14px;
      font-weight:800;
      cursor:pointer;
      background: #1f1f27;
      color:white;
      box-shadow: 0 10px 20px rgba(20,10,30,.10);
    }
    button.ghost{
      background: rgba(255,255,255,.92);
      color: var(--ink);
      border:1px solid var(--line);
      box-shadow: 0 8px 18px rgba(20,10,30,.06);
    }
    button.pink{
      background: linear-gradient(135deg, var(--accent), #ff84b8);
    }
    button.violet{
      background: linear-gradient(135deg, var(--accent2), #9a87ff);
    }
    button.good{
      background: linear-gradient(135deg, var(--good), #3ad79e);
    }
    button.bad{
      background: linear-gradient(135deg, var(--bad), #ff7b7b);
    }
    button:active{transform: translateY(1px)}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .small{font-size:12px}
    .kpi{
      display:grid; gap:10px;
    }
    @media (min-width:560px){
      .kpi{grid-template-columns: 1fr 1fr}
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:12px;
      background: rgba(255,255,255,.88);
    }
    .kpi .box .t{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
    .kpi .box .v{font-size:20px;font-weight:900;margin-top:4px}
    .kpi .box .v.good{color:var(--good)}
    .kpi .box .v.bad{color:var(--bad)}
    .list{
      display:grid; gap:10px; margin-top:10px;
    }
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      border-radius: var(--radius2);
      padding:12px;
      display:grid;
      gap:10px;
    }
    .itemTop{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .itemName{
      display:flex;flex-direction:column;gap:3px;min-width:0;
    }
    .itemName b{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(124,92,255,.08);
      color:#3f2bb6;
      font-weight:800;
    }
    .chip.consigned{
      background: rgba(242,161,0,.10);
      color:#8a5a00;
      border-color: rgba(242,161,0,.20);
    }
    .chip.owned{
      background: rgba(26,168,111,.10);
      color:#0b6f49;
      border-color: rgba(26,168,111,.20);
    }
    .controls{
      display:flex;flex-wrap:wrap;align-items:center;gap:8px;
    }
    .qty{
      width:86px;
      text-align:center;
      font-weight:900;
    }
    .iconBtn{
      width:40px;height:40px;border-radius: 14px;
      padding:0;
      display:grid;place-items:center;
      font-size:18px;
    }
    .dangerLink{
      color: var(--bad);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .hint{
      background: linear-gradient(135deg, rgba(255,95,162,.10), rgba(124,92,255,.08));
      border:1px dashed rgba(255,95,162,.35);
      border-radius: var(--radius2);
      padding:10px 12px;
      font-size:12px;
      color: #3b2a38;
    }
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; z-index:6;
      background: rgba(255,255,255,.70);
      border-top: 1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .footerbar .wrap{
      padding:10px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .status{
      font-size:12px;color:var(--muted);
      display:flex;align-items:center;gap:8px;
      min-width:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .divider{height:1px;background:var(--line);margin:12px 0}
    .right{text-align:right}
    .flex{display:flex;gap:10px;align-items:center}
    .grow{flex:1}
    .hide{display:none !important}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">üßæ</div>
        <div class="title">
          <b>Field Accounting System</b>
          <span>2 tabs ‚Ä¢ offline saving ‚Ä¢ export sheets ‚ú®</span>
        </div>
      </div>
      <span class="pill" id="todayPill">üìÖ</span>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabSales" role="button" aria-label="Sales Tracker tab">üõçÔ∏è Sales Tracker <span class="pill">Catalog + Sold</span></div>
      <div class="tab" id="tabCash" role="button" aria-label="Cash Flow tab">üí∏ Cash Flow <span class="pill">Expenses + Taxes</span></div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- SALES TAB -->
  <section id="salesSection">

    <div class="row two">
      <div class="card">
        <h2>üß∏ Item Catalog <span class="pill">import / export</span></h2>
        <div class="sub">Add your items here. Everything saves automatically on your device.</div>

        <div class="hint">
          <b>Consigned items:</b> you track <b>original cost</b> + <b>markup</b>.
          For profits, only <b>markup</b> counts (your earnings). For cash-in, the full selling price counts.
        </div>

        <div class="divider"></div>

        <div class="grid cols2">
          <div>
            <label>Item name</label>
            <input id="c_name" placeholder="e.g., Scrunchie üéÄ" />
          </div>
          <div>
            <label>Type</label>
            <select id="c_type">
              <option value="owned">Owned (regular)</option>
              <option value="consigned">Consigned</option>
            </select>
          </div>
        </div>

        <div class="grid cols2" id="ownedFields">
          <div>
            <label>Cost (‚Ç±)</label>
            <input id="c_cost" inputmode="decimal" placeholder="e.g., 25" />
          </div>
          <div>
            <label>Selling price (‚Ç±)</label>
            <input id="c_price" inputmode="decimal" placeholder="e.g., 60" />
          </div>
        </div>

        <div class="grid cols2 hide" id="consignedFields">
          <div>
            <label>Original cost (‚Ç±)</label>
            <input id="c_orig" inputmode="decimal" placeholder="e.g., 50" />
          </div>
          <div>
            <label>Markup (‚Ç±)</label>
            <input id="c_markup" inputmode="decimal" placeholder="e.g., 20" />
          </div>
        </div>

        <div class="btnrow">
          <button class="pink" id="btnAddItem">‚ûï Add to catalog</button>
          <button class="ghost" id="btnExportCatalog">‚¨áÔ∏è Export catalog JSON</button>
          <button class="ghost" id="btnImportCatalog">‚¨ÜÔ∏è Import catalog JSON</button>
          <input type="file" id="catalogFile" accept="application/json" class="hide" />
          <button class="bad" id="btnClearSold" title="Clears sold quantities only">üßº Clear sold counts</button>
        </div>

        <div class="divider"></div>

        <div class="flex">
          <div class="grow">
            <label>Search</label>
            <input id="searchBox" placeholder="Search items‚Ä¶ (name contains)" />
          </div>
          <div style="width:160px">
            <label>Sort</label>
            <select id="sortBox">
              <option value="name">Name (A‚ÄìZ)</option>
              <option value="type">Type (Owned/Consigned)</option>
              <option value="profit">Profit per unit (high‚Üílow)</option>
              <option value="sales">Price per unit (high‚Üílow)</option>
            </select>
          </div>
        </div>

        <div class="list" id="catalogList"></div>
      </div>

      <div class="card">
        <h2>üìä Sales Summary <span class="pill">auto-calc</span></h2>
        <div class="sub">As you tap +/‚àí or type qty, totals update instantly.</div>

        <div class="kpi">
          <div class="box">
            <div class="t">üíµ Gross Cash-In (from sales)</div>
            <div class="v mono" id="k_gross">‚Ç±0.00</div>
          </div>
          <div class="box">
            <div class="t">‚ú® Profit (Sales ‚àí Cost; consigned = markup)</div>
            <div class="v mono good" id="k_profit">‚Ç±0.00</div>
          </div>
          <div class="box">
            <div class="t">üì¶ Regular Items Cost (COGS)</div>
            <div class="v mono" id="k_cost">‚Ç±0.00</div>
          </div>
          <div class="box">
            <div class="t">ü§ù Consignor Payable (orig √ó qty)</div>
            <div class="v mono" id="k_payable">‚Ç±0.00</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid cols2">
          <div>
            <label>Date (for export)</label>
            <input id="salesDate" type="date" />
          </div>
          <div>
            <label>Notes</label>
            <input id="salesNotes" placeholder="e.g., Stall @ bazaar ‚ú®" />
          </div>
        </div>

        <div class="btnrow">
          <button class="violet" id="btnExportSalesCsv">üßæ Export Sales Sheet (CSV)</button>
          <button class="ghost" id="btnExportSalesJson">üíæ Export Sales Data (JSON)</button>
        </div>

        <div class="divider"></div>

        <div class="hint">
          <b>Tip:</b> Export CSV then open in Google Sheets / Excel. On mobile, it should download like a normal file.
        </div>
      </div>
    </div>

  </section>

  <!-- CASH TAB -->
  <section id="cashSection" class="hide">

    <div class="row two">
      <div class="card">
        <h2>üßã Cash-In & Expenses <span class="pill">editable</span></h2>
        <div class="sub">Cash-in auto-reads from sales. Add any expenses you want.</div>

        <div class="kpi">
          <div class="box">
            <div class="t">üíµ Cash In (Gross Sales)</div>
            <div class="v mono" id="cf_in">‚Ç±0.00</div>
          </div>
          <div class="box">
            <div class="t">üßæ Total Expenses</div>
            <div class="v mono bad" id="cf_exp">‚Ç±0.00</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid cols2">
          <div>
            <label>Expense label</label>
            <input id="e_label" placeholder="e.g., Booth fee / Packaging / Snacks üçü" />
          </div>
          <div>
            <label>Amount (‚Ç±)</label>
            <input id="e_amount" inputmode="decimal" placeholder="e.g., 120" />
          </div>
        </div>

        <div class="btnrow">
          <button class="pink" id="btnAddExpense">‚ûï Add expense</button>
          <button class="bad" id="btnClearExpenses">üóëÔ∏è Clear expenses</button>
        </div>

        <div class="divider"></div>

        <div class="list" id="expenseList"></div>
      </div>

      <div class="card">
        <h2>üßÆ Cash Flow Summary <span class="pill">tax + tithe</span></h2>
        <div class="sub">After expenses: take 10% as Taxes, then 10% of the remainder as Tithe.</div>

        <div class="grid cols2">
          <div>
            <label>Date (for export)</label>
            <input id="cashDate" type="date" />
          </div>
          <div>
            <label>Notes</label>
            <input id="cashNotes" placeholder="e.g., Day 1 sales + supplies ‚ú®" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="kpi">
          <div class="box">
            <div class="t">üßæ Net Before Taxes (Cash In ‚àí Expenses)</div>
            <div class="v mono" id="cf_net">‚Ç±0.00</div>
          </div>
          <div class="box">
            <div class="t">üèõÔ∏è Taxes (10% of Net Before Taxes)</div>
            <div class="v mono" id="cf_tax">‚Ç±0.00</div>
          </div>
          <div class="box">
            <div class="t">‚õ™ Tithe (10% of After-Tax)</div>
            <div class="v mono" id="cf_tithe">‚Ç±0.00</div>
          </div>
          <div class="box">
            <div class="t">üíñ Ending Cash Balance</div>
            <div class="v mono good" id="cf_end">‚Ç±0.00</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="btnrow">
          <button class="violet" id="btnExportCashCsv">üì§ Export Cash Flow Sheet (CSV)</button>
          <button class="ghost" id="btnExportCashJson">üíæ Export Cash Data (JSON)</button>
        </div>

        <div class="divider"></div>

        <div class="hint">
          If Net Before Taxes is negative, this app sets Taxes and Tithe to <b>‚Ç±0</b> (so you don‚Äôt ‚Äútax‚Äù a loss).
        </div>
      </div>
    </div>

  </section>

</main>

<div class="footerbar">
  <div class="wrap">
    <div class="status" id="statusText">‚ú® Saved locally on this device</div>
    <div class="flex">
      <button class="ghost" id="btnBackupAll">üß∑ Backup ALL (JSON)</button>
      <button class="ghost" id="btnRestoreAll">üß∑ Restore ALL (JSON)</button>
      <input type="file" id="allFile" accept="application/json" class="hide" />
    </div>
  </div>
</div>

<script>
/* =========================================================
   Field Accounting System (single-file, offline-first)
   - Catalog supports Owned and Consigned items
   - Sold quantities tracked
   - Cashflow: expenses + 10% tax + 10% tithe
   - Export CSV "sheets" + JSON backups
   ========================================================= */

const LS_KEY = "fieldAccountingSystem_v1";
const fmtMoney = (n) => {
  const x = Number.isFinite(n) ? n : 0;
  return "‚Ç±" + x.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
};
const toNum = (v) => {
  if (v === null || v === undefined) return 0;
  const s = String(v).replace(/,/g,"").trim();
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : 0;
};
const uid = () => Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);

const stateDefault = () => ({
  catalog: [
    // sample cute defaults (can be deleted)
    { id: uid(), name: "Scrunchie üéÄ", type:"owned", cost: 25, price: 60, soldQty: 0 },
    { id: uid(), name: "Beaded Keychain ‚ú®", type:"owned", cost: 40, price: 99, soldQty: 0 },
    { id: uid(), name: "Consigned Dress üëó", type:"consigned", original: 350, markup: 150, soldQty: 0 }
  ],
  salesMeta: {
    date: "",
    notes: ""
  },
  cash: {
    expenses: [],
    meta: { date:"", notes:"" }
  },
  ui: { activeTab: "sales" }
});

let state = loadState();

/* ---------- DOM ---------- */
const el = (id)=>document.getElementById(id);

const tabSales = el("tabSales");
const tabCash  = el("tabCash");
const salesSection = el("salesSection");
const cashSection  = el("cashSection");

const todayPill = el("todayPill");
todayPill.textContent = "üìÖ " + new Date().toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });

/* Catalog inputs */
const c_name   = el("c_name");
const c_type   = el("c_type");
const c_cost   = el("c_cost");
const c_price  = el("c_price");
const c_orig   = el("c_orig");
const c_markup = el("c_markup");

const ownedFields = el("ownedFields");
const consignedFields = el("consignedFields");

const btnAddItem = el("btnAddItem");
const btnExportCatalog = el("btnExportCatalog");
const btnImportCatalog = el("btnImportCatalog");
const catalogFile = el("catalogFile");
const btnClearSold = el("btnClearSold");

const searchBox = el("searchBox");
const sortBox = el("sortBox");
const catalogList = el("catalogList");

/* Sales KPIs */
const k_gross = el("k_gross");
const k_profit = el("k_profit");
const k_cost = el("k_cost");
const k_payable = el("k_payable");

const salesDate = el("salesDate");
const salesNotes = el("salesNotes");
const btnExportSalesCsv = el("btnExportSalesCsv");
const btnExportSalesJson = el("btnExportSalesJson");

/* Cashflow */
const cf_in = el("cf_in");
const cf_exp = el("cf_exp");
const e_label = el("e_label");
const e_amount = el("e_amount");
const btnAddExpense = el("btnAddExpense");
const btnClearExpenses = el("btnClearExpenses");
const expenseList = el("expenseList");

const cashDate = el("cashDate");
const cashNotes = el("cashNotes");

const cf_net = el("cf_net");
const cf_tax = el("cf_tax");
const cf_tithe = el("cf_tithe");
const cf_end = el("cf_end");

const btnExportCashCsv = el("btnExportCashCsv");
const btnExportCashJson = el("btnExportCashJson");

/* Footer backup */
const statusText = el("statusText");
const btnBackupAll = el("btnBackupAll");
const btnRestoreAll = el("btnRestoreAll");
const allFile = el("allFile");

/* ---------- Tabs ---------- */
function setTab(which){
  state.ui.activeTab = which;
  if(which === "sales"){
    tabSales.classList.add("active");
    tabCash.classList.remove("active");
    salesSection.classList.remove("hide");
    cashSection.classList.add("hide");
  }else{
    tabCash.classList.add("active");
    tabSales.classList.remove("active");
    cashSection.classList.remove("hide");
    salesSection.classList.add("hide");
  }
  saveState();
}
tabSales.addEventListener("click", ()=>setTab("sales"));
tabCash.addEventListener("click", ()=>setTab("cash"));

/* ---------- Type toggle for catalog form ---------- */
function refreshCatalogFormMode(){
  const t = c_type.value;
  if(t === "consigned"){
    ownedFields.classList.add("hide");
    consignedFields.classList.remove("hide");
  }else{
    consignedFields.classList.add("hide");
    ownedFields.classList.remove("hide");
  }
}
c_type.addEventListener("change", refreshCatalogFormMode);

/* ---------- Load meta fields ---------- */
function hydrateMeta(){
  salesDate.value = state.salesMeta.date || "";
  salesNotes.value = state.salesMeta.notes || "";
  cashDate.value = state.cash.meta.date || "";
  cashNotes.value = state.cash.meta.notes || "";
}

/* ---------- State persistence ---------- */
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return stateDefault();
    const s = JSON.parse(raw);

    // Basic hardening / defaults
    if(!s.catalog) s.catalog = [];
    if(!s.salesMeta) s.salesMeta = {date:"", notes:""};
    if(!s.cash) s.cash = {expenses:[], meta:{date:"", notes:""}};
    if(!s.cash.expenses) s.cash.expenses = [];
    if(!s.ui) s.ui = {activeTab:"sales"};
    return s;
  }catch(e){
    return stateDefault();
  }
}
let saveTimer = null;
function saveState(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>{
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    statusText.textContent = "‚ú® Saved locally ‚Ä¢ " + new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }, 60);
}

/* ---------- Calculations ---------- */
function calcSalesTotals(){
  let gross = 0;
  let cost = 0;       // only owned COGS
  let profit = 0;     // owned: (price - cost) * qty; consigned: markup*qty
  let payable = 0;    // consigned original * qty (for reference)

  for(const it of state.catalog){
    const q = toNum(it.soldQty);
    if(q <= 0) continue;

    if(it.type === "consigned"){
      const original = toNum(it.original);
      const markup = toNum(it.markup);
      const sell = original + markup;

      gross += sell * q;         // cash-in is full selling price
      profit += markup * q;      // your earnings
      payable += original * q;   // amount to remit to consignor
      // cost does NOT include consigned original in this model (since it isn't your COGS)
    }else{
      const c = toNum(it.cost);
      const p = toNum(it.price);
      gross += p * q;
      cost  += c * q;
      profit += (p - c) * q;
    }
  }

  return {gross, cost, profit, payable};
}

function calcCashFlow(){
  const {gross} = calcSalesTotals();
  const expenses = state.cash.expenses.reduce((sum, ex)=> sum + toNum(ex.amount), 0);

  const netBefore = gross - expenses;

  const taxableBase = Math.max(0, netBefore);
  const taxes = taxableBase * 0.10;

  const afterTax = netBefore - taxes;
  const titheBase = Math.max(0, afterTax);
  const tithe = titheBase * 0.10;

  const ending = afterTax - tithe;

  return {cashIn:gross, expenses, netBefore, taxes, tithe, ending};
}

/* ---------- Rendering ---------- */
function render(){
  // Tab state
  setTab(state.ui.activeTab || "sales");

  hydrateMeta();
  refreshCatalogFormMode();

  // Render catalog list with filters
  const q = (searchBox.value || "").trim().toLowerCase();
  let items = state.catalog.slice();

  if(q){
    items = items.filter(it => (it.name || "").toLowerCase().includes(q));
  }

  const sorter = sortBox.value;
  items.sort((a,b)=>{
    const an = (a.name||"").toLowerCase();
    const bn = (b.name||"").toLowerCase();

    if(sorter === "name") return an.localeCompare(bn);
    if(sorter === "type") return (a.type||"").localeCompare(b.type||"") || an.localeCompare(bn);
    if(sorter === "profit"){
      const ap = profitPerUnit(a);
      const bp = profitPerUnit(b);
      return bp - ap || an.localeCompare(bn);
    }
    if(sorter === "sales"){
      const as = sellPrice(a);
      const bs = sellPrice(b);
      return bs - as || an.localeCompare(bn);
    }
    return an.localeCompare(bn);
  });

  catalogList.innerHTML = "";
  if(items.length === 0){
    const div = document.createElement("div");
    div.className = "hint";
    div.textContent = "No items found. Add some to the catalog ‚ú®";
    catalogList.appendChild(div);
  }else{
    for(const it of items){
      catalogList.appendChild(renderItem(it));
    }
  }

  // Sales totals
  const totals = calcSalesTotals();
  k_gross.textContent   = fmtMoney(totals.gross);
  k_cost.textContent    = fmtMoney(totals.cost);
  k_profit.textContent  = fmtMoney(totals.profit);
  k_payable.textContent = fmtMoney(totals.payable);
  k_profit.classList.toggle("bad", totals.profit < 0);

  // Cashflow totals
  const cf = calcCashFlow();
  cf_in.textContent = fmtMoney(cf.cashIn);
  cf_exp.textContent = fmtMoney(cf.expenses);
  cf_net.textContent = fmtMoney(cf.netBefore);
  cf_tax.textContent = fmtMoney(cf.taxes);
  cf_tithe.textContent = fmtMoney(cf.tithe);
  cf_end.textContent = fmtMoney(cf.ending);
  cf_end.classList.toggle("bad", cf.ending < 0);

  // Expenses list
  expenseList.innerHTML = "";
  if(state.cash.expenses.length === 0){
    const div = document.createElement("div");
    div.className = "hint";
    div.textContent = "No expenses yet. Add anything you spent while selling (fees, supplies, snacks, etc.) üç°";
    expenseList.appendChild(div);
  }else{
    state.cash.expenses.forEach(ex => {
      expenseList.appendChild(renderExpense(ex));
    });
  }

  saveState();
}

function profitPerUnit(it){
  if(it.type === "consigned") return toNum(it.markup);
  return toNum(it.price) - toNum(it.cost);
}
function sellPrice(it){
  if(it.type === "consigned") return toNum(it.original) + toNum(it.markup);
  return toNum(it.price);
}

function renderItem(it){
  const wrap = document.createElement("div");
  wrap.className = "item";

  const top = document.createElement("div");
  top.className = "itemTop";

  const name = document.createElement("div");
  name.className = "itemName";

  const b = document.createElement("b");
  b.textContent = it.name || "(Unnamed item)";
  name.appendChild(b);

  const chips = document.createElement("div");
  chips.className = "chips";

  const chipType = document.createElement("span");
  chipType.className = "chip " + (it.type === "consigned" ? "consigned" : "owned");
  chipType.textContent = it.type === "consigned" ? "ü§ù Consigned" : "üì¶ Owned";
  chips.appendChild(chipType);

  const chipUnit = document.createElement("span");
  chipUnit.className = "chip";
  chipUnit.textContent = "üí∏ Sell: " + fmtMoney(sellPrice(it)).replace("‚Ç±","‚Ç±");
  chips.appendChild(chipUnit);

  const chipProfit = document.createElement("span");
  chipProfit.className = "chip";
  chipProfit.textContent = "‚ú® Profit/unit: " + fmtMoney(profitPerUnit(it)).replace("‚Ç±","‚Ç±");
  chips.appendChild(chipProfit);

  if(it.type === "consigned"){
    const chipPay = document.createElement("span");
    chipPay.className = "chip";
    chipPay.textContent = "üßæ Orig: " + fmtMoney(toNum(it.original)).replace("‚Ç±","‚Ç±");
    chips.appendChild(chipPay);
  }else{
    const chipCost = document.createElement("span");
    chipCost.className = "chip";
    chipCost.textContent = "üßæ Cost: " + fmtMoney(toNum(it.cost)).replace("‚Ç±","‚Ç±");
    chips.appendChild(chipCost);
  }

  name.appendChild(chips);

  const del = document.createElement("div");
  del.className = "dangerLink";
  del.textContent = "Delete";
  del.title = "Delete this item from catalog";
  del.addEventListener("click", ()=>{
    if(confirm(`Delete "${it.name}" from the catalog?`)){
      state.catalog = state.catalog.filter(x=>x.id!==it.id);
      render();
    }
  });

  top.appendChild(name);
  top.appendChild(del);

  const controls = document.createElement("div");
  controls.className = "controls";

  const btnMinus = document.createElement("button");
  btnMinus.className = "iconBtn ghost";
  btnMinus.textContent = "‚àí";
  btnMinus.addEventListener("click", ()=>{
    it.soldQty = Math.max(0, toNum(it.soldQty) - 1);
    render();
  });

  const qty = document.createElement("input");
  qty.className = "qty";
  qty.inputMode = "numeric";
  qty.value = String(toNum(it.soldQty));
  qty.addEventListener("input", ()=>{
    it.soldQty = Math.max(0, Math.floor(toNum(qty.value)));
    saveState();
    // lightweight update without full rerender flicker:
    updateTotalsOnly();
  });
  qty.addEventListener("change", ()=>render());

  const btnPlus = document.createElement("button");
  btnPlus.className = "iconBtn ghost";
  btnPlus.textContent = "+";
  btnPlus.addEventListener("click", ()=>{
    it.soldQty = Math.max(0, toNum(it.soldQty) + 1);
    render();
  });

  const quick = document.createElement("span");
  quick.className = "muted small";
  quick.textContent = "Sold qty";

  const edit = document.createElement("button");
  edit.className = "ghost";
  edit.textContent = "‚úèÔ∏è Edit";
  edit.addEventListener("click", ()=>openEditPrompt(it));

  controls.appendChild(quick);
  controls.appendChild(btnMinus);
  controls.appendChild(qty);
  controls.appendChild(btnPlus);
  controls.appendChild(edit);

  wrap.appendChild(top);
  wrap.appendChild(controls);

  return wrap;
}

function openEditPrompt(it){
  // Simple, mobile-friendly prompts (fast + reliable)
  const newName = prompt("Item name:", it.name || "");
  if(newName === null) return;
  it.name = newName.trim() || it.name;

  const newType = prompt('Type: enter "owned" or "consigned"', it.type || "owned");
  if(newType !== null){
    const t = (newType || "").toLowerCase().trim();
    if(t === "owned" || t === "consigned") it.type = t;
  }

  if(it.type === "consigned"){
    const o = prompt("Original cost (‚Ç±):", String(toNum(it.original)));
    if(o !== null) it.original = toNum(o);
    const m = prompt("Markup (‚Ç±):", String(toNum(it.markup)));
    if(m !== null) it.markup = toNum(m);
    // keep fields tidy
    delete it.cost; delete it.price;
  }else{
    const c = prompt("Cost (‚Ç±):", String(toNum(it.cost)));
    if(c !== null) it.cost = toNum(c);
    const p = prompt("Selling price (‚Ç±):", String(toNum(it.price)));
    if(p !== null) it.price = toNum(p);
    delete it.original; delete it.markup;
  }
  render();
}

function renderExpense(ex){
  const wrap = document.createElement("div");
  wrap.className = "item";

  const top = document.createElement("div");
  top.className = "itemTop";

  const name = document.createElement("div");
  name.className = "itemName";
  const b = document.createElement("b");
  b.textContent = ex.label || "(Expense)";
  name.appendChild(b);

  const chips = document.createElement("div");
  chips.className = "chips";
  const chip = document.createElement("span");
  chip.className = "chip";
  chip.textContent = "üßæ " + fmtMoney(toNum(ex.amount));
  chips.appendChild(chip);
  name.appendChild(chips);

  const del = document.createElement("div");
  del.className = "dangerLink";
  del.textContent = "Remove";
  del.addEventListener("click", ()=>{
    state.cash.expenses = state.cash.expenses.filter(x=>x.id!==ex.id);
    render();
  });

  top.appendChild(name);
  top.appendChild(del);

  const controls = document.createElement("div");
  controls.className = "controls";

  const edit = document.createElement("button");
  edit.className = "ghost";
  edit.textContent = "‚úèÔ∏è Edit";
  edit.addEventListener("click", ()=>{
    const nl = prompt("Expense label:", ex.label || "");
    if(nl !== null) ex.label = nl.trim();
    const na = prompt("Amount (‚Ç±):", String(toNum(ex.amount)));
    if(na !== null) ex.amount = toNum(na);
    render();
  });

  controls.appendChild(edit);

  wrap.appendChild(top);
  wrap.appendChild(controls);
  return wrap;
}

/* Totals-only update for smoother qty typing */
function updateTotalsOnly(){
  const totals = calcSalesTotals();
  k_gross.textContent   = fmtMoney(totals.gross);
  k_cost.textContent    = fmtMoney(totals.cost);
  k_profit.textContent  = fmtMoney(totals.profit);
  k_payable.textContent = fmtMoney(totals.payable);

  const cf = calcCashFlow();
  cf_in.textContent = fmtMoney(cf.cashIn);
  cf_exp.textContent = fmtMoney(cf.expenses);
  cf_net.textContent = fmtMoney(cf.netBefore);
  cf_tax.textContent = fmtMoney(cf.taxes);
  cf_tithe.textContent = fmtMoney(cf.tithe);
  cf_end.textContent = fmtMoney(cf.ending);

  saveState();
}

/* ---------- Actions: Add item ---------- */
btnAddItem.addEventListener("click", ()=>{
  const name = (c_name.value || "").trim();
  if(!name){
    alert("Please enter an item name ‚ú®");
    return;
  }
  const type = c_type.value;

  if(type === "consigned"){
    const original = toNum(c_orig.value);
    const markup = toNum(c_markup.value);
    if(original < 0 || markup < 0){
      alert("Original and markup should be 0 or higher.");
      return;
    }
    state.catalog.push({ id: uid(), name, type:"consigned", original, markup, soldQty: 0 });
  }else{
    const cost = toNum(c_cost.value);
    const price = toNum(c_price.value);
    if(cost < 0 || price < 0){
      alert("Cost and price should be 0 or higher.");
      return;
    }
    state.catalog.push({ id: uid(), name, type:"owned", cost, price, soldQty: 0 });
  }

  c_name.value = "";
  c_cost.value = "";
  c_price.value = "";
  c_orig.value = "";
  c_markup.value = "";
  render();
});

/* ---------- Catalog import/export ---------- */
btnExportCatalog.addEventListener("click", ()=>{
  // Export catalog ONLY (no sold/expenses/meta)
  const catalogClean = state.catalog.map(it=>{
    const o = { id: it.id, name: it.name, type: it.type };
    if(it.type === "consigned"){
      o.original = toNum(it.original);
      o.markup = toNum(it.markup);
    }else{
      o.cost = toNum(it.cost);
      o.price = toNum(it.price);
    }
    return o;
  });
  const payload = { exportedAt: new Date().toISOString(), catalog: catalogClean };
  downloadJson(payload, "field_catalog.json");
});

btnImportCatalog.addEventListener("click", ()=> catalogFile.click());

catalogFile.addEventListener("change", async ()=>{
  const f = catalogFile.files?.[0];
  catalogFile.value = "";
  if(!f) return;

  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    const incoming = Array.isArray(obj) ? obj : obj.catalog;

    if(!Array.isArray(incoming)){
      alert("Invalid JSON. Expected { catalog: [...] } or an array.");
      return;
    }

    // merge by id if present; else append new
    const byId = new Map(state.catalog.map(x=>[x.id, x]));
    for(const raw of incoming){
      const clean = normalizeCatalogItem(raw);
      if(!clean) continue;

      if(clean.id && byId.has(clean.id)){
        const existing = byId.get(clean.id);
        // keep existing soldQty
        const soldQty = toNum(existing.soldQty);
        Object.assign(existing, clean);
        existing.soldQty = soldQty;
      }else{
        clean.id = clean.id || uid();
        clean.soldQty = 0;
        state.catalog.push(clean);
      }
    }

    render();
    alert("Catalog imported ‚ú®");
  }catch(e){
    alert("Import failed. Please check the JSON file.");
  }
});

function normalizeCatalogItem(raw){
  if(!raw || typeof raw !== "object") return null;
  const type = (raw.type || "owned").toLowerCase().trim();
  const name = String(raw.name || "").trim();
  if(!name) return null;

  const it = {
    id: raw.id ? String(raw.id) : "",
    name,
    type: (type === "consigned" ? "consigned" : "owned")
  };

  if(it.type === "consigned"){
    it.original = toNum(raw.original);
    it.markup = toNum(raw.markup);
  }else{
    it.cost = toNum(raw.cost);
    it.price = toNum(raw.price);
  }
  return it;
}

/* ---------- Clear sold counts ---------- */
btnClearSold.addEventListener("click", ()=>{
  if(!confirm("Clear ALL sold quantities back to 0?")) return;
  state.catalog.forEach(it => it.soldQty = 0);
  render();
});

/* ---------- Search / sort ---------- */
searchBox.addEventListener("input", ()=>render());
sortBox.addEventListener("change", ()=>render());

/* ---------- Sales meta ---------- */
salesDate.addEventListener("change", ()=>{
  state.salesMeta.date = salesDate.value || "";
  saveState();
});
salesNotes.addEventListener("input", ()=>{
  state.salesMeta.notes = salesNotes.value || "";
  saveState();
});

/* ---------- Cash meta ---------- */
cashDate.addEventListener("change", ()=>{
  state.cash.meta.date = cashDate.value || "";
  saveState();
});
cashNotes.addEventListener("input", ()=>{
  state.cash.meta.notes = cashNotes.value || "";
  saveState();
});

/* ---------- Expenses ---------- */
btnAddExpense.addEventListener("click", ()=>{
  const label = (e_label.value || "").trim();
  const amount = toNum(e_amount.value);
  if(!label){
    alert("Please enter an expense label ‚ú®");
    return;
  }
  if(amount <= 0){
    alert("Please enter an amount greater than 0.");
    return;
  }
  state.cash.expenses.push({ id: uid(), label, amount });
  e_label.value = "";
  e_amount.value = "";
  render();
});

btnClearExpenses.addEventListener("click", ()=>{
  if(!confirm("Clear ALL expenses?")) return;
  state.cash.expenses = [];
  render();
});

/* ---------- Exports: Sales CSV & JSON ---------- */
btnExportSalesCsv.addEventListener("click", ()=>{
  const rows = buildSalesRows();
  const csv = toCsv(rows);
  const name = `sales_sheet_${safeDate(state.salesMeta.date)}.csv`;
  downloadText(csv, name, "text/csv");
});

btnExportSalesJson.addEventListener("click", ()=>{
  const totals = calcSalesTotals();
  const payload = {
    exportedAt: new Date().toISOString(),
    salesMeta: {...state.salesMeta},
    totals,
    soldItems: buildSalesRows().slice(1).map(r=>({
      item: r["Item"],
      type: r["Type"],
      qty: toNum(r["Qty"]),
      sellPrice: toNum(r["SellPrice"]),
      costOrOriginal: toNum(r["CostOrOriginal"]),
      markup: toNum(r["Markup"]),
      gross: toNum(r["GrossSales"]),
      profit: toNum(r["Profit"]),
      consignorPayable: toNum(r["ConsignorPayable"])
    }))
  };
  downloadJson(payload, `sales_data_${safeDate(state.salesMeta.date)}.json`);
});

function buildSalesRows(){
  const header = {
    "Date": state.salesMeta.date || "",
    "Notes": state.salesMeta.notes || "",
    "Item": "Item",
    "Type": "Type",
    "Qty": "Qty",
    "SellPrice": "SellPrice",
    "CostOrOriginal": "CostOrOriginal",
    "Markup": "Markup",
    "GrossSales": "GrossSales",
    "Profit": "Profit",
    "ConsignorPayable": "ConsignorPayable"
  };
  const rows = [header];

  // line items
  const sold = state.catalog.filter(it => toNum(it.soldQty) > 0);
  sold.sort((a,b)=> (a.name||"").localeCompare(b.name||""));

  for(const it of sold){
    const qty = Math.floor(toNum(it.soldQty));
    if(qty <= 0) continue;

    if(it.type === "consigned"){
      const original = toNum(it.original);
      const markup = toNum(it.markup);
      const sell = original + markup;

      rows.push({
        "Date": state.salesMeta.date || "",
        "Notes": state.salesMeta.notes || "",
        "Item": it.name,
        "Type": "Consigned",
        "Qty": qty,
        "SellPrice": sell,
        "CostOrOriginal": original,
        "Markup": markup,
        "GrossSales": sell * qty,
        "Profit": markup * qty,
        "ConsignorPayable": original * qty
      });
    }else{
      const cost = toNum(it.cost);
      const price = toNum(it.price);
      rows.push({
        "Date": state.salesMeta.date || "",
        "Notes": state.salesMeta.notes || "",
        "Item": it.name,
        "Type": "Owned",
        "Qty": qty,
        "SellPrice": price,
        "CostOrOriginal": cost,
        "Markup": (price - cost),
        "GrossSales": price * qty,
        "Profit": (price - cost) * qty,
        "ConsignorPayable": 0
      });
    }
  }

  // totals footer row
  const totals = calcSalesTotals();
  rows.push({
    "Date": state.salesMeta.date || "",
    "Notes": "TOTALS",
    "Item": "",
    "Type": "",
    "Qty": "",
    "SellPrice": "",
    "CostOrOriginal": "",
    "Markup": "",
    "GrossSales": totals.gross,
    "Profit": totals.profit,
    "ConsignorPayable": totals.payable
  });

  return rows;
}

/* ---------- Exports: Cash CSV & JSON ---------- */
btnExportCashCsv.addEventListener("click", ()=>{
  const rows = buildCashRows();
  const csv = toCsv(rows);
  const name = `cashflow_sheet_${safeDate(state.cash.meta.date)}.csv`;
  downloadText(csv, name, "text/csv");
});

btnExportCashJson.addEventListener("click", ()=>{
  const cf = calcCashFlow();
  const payload = {
    exportedAt: new Date().toISOString(),
    cashMeta: {...state.cash.meta},
    cashInFromSales: cf.cashIn,
    expenses: state.cash.expenses.map(x=>({label:x.label, amount:toNum(x.amount)})),
    summary: cf
  };
  downloadJson(payload, `cashflow_data_${safeDate(state.cash.meta.date)}.json`);
});

function buildCashRows(){
  const cf = calcCashFlow();
  const rows = [];
  rows.push({ "Date": state.cash.meta.date || "", "Notes": state.cash.meta.notes || "", "Type": "Cash In", "Label": "Gross Sales", "Amount": cf.cashIn });

  if(state.cash.expenses.length){
    for(const ex of state.cash.expenses){
      rows.push({ "Date": state.cash.meta.date || "", "Notes": state.cash.meta.notes || "", "Type": "Expense", "Label": ex.label, "Amount": toNum(ex.amount) });
    }
  }else{
    rows.push({ "Date": state.cash.meta.date || "", "Notes": state.cash.meta.notes || "", "Type": "Expense", "Label": "(none)", "Amount": 0 });
  }

  rows.push({ "Date": state.cash.meta.date || "", "Notes": "SUMMARY", "Type": "Net Before Taxes", "Label": "", "Amount": cf.netBefore });
  rows.push({ "Date": state.cash.meta.date || "", "Notes": "SUMMARY", "Type": "Taxes (10%)", "Label": "", "Amount": cf.taxes });
  rows.push({ "Date": state.cash.meta.date || "", "Notes": "SUMMARY", "Type": "Tithe (10%)", "Label": "", "Amount": cf.tithe });
  rows.push({ "Date": state.cash.meta.date || "", "Notes": "SUMMARY", "Type": "Ending Balance", "Label": "", "Amount": cf.ending });

  return rows;
}

/* ---------- Backup/Restore ALL ---------- */
btnBackupAll.addEventListener("click", ()=>{
  const payload = { exportedAt: new Date().toISOString(), state };
  downloadJson(payload, `field_accounting_backup_${safeDate(new Date().toISOString().slice(0,10))}.json`);
});

btnRestoreAll.addEventListener("click", ()=> allFile.click());

allFile.addEventListener("change", async ()=>{
  const f = allFile.files?.[0];
  allFile.value = "";
  if(!f) return;
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    if(!obj || typeof obj !== "object" || !obj.state){
      alert("Invalid backup. Expected { state: ... }");
      return;
    }
    if(!confirm("Restore ALL data from this backup? This will overwrite current data on this device.")) return;
    state = obj.state;
    saveState();
    render();
    alert("Restored ‚ú®");
  }catch(e){
    alert("Restore failed. Please check the JSON file.");
  }
});

/* ---------- CSV helpers ---------- */
function toCsv(rows){
  if(!rows || !rows.length) return "";
  const headers = Object.keys(rows[0]);
  const esc = (v) => {
    const s = (v === null || v === undefined) ? "" : String(v);
    const needs = /[",\n]/.test(s);
    const out = s.replace(/"/g,'""');
    return needs ? `"${out}"` : out;
  };
  const lines = [];
  lines.push(headers.map(esc).join(","));
  for(const r of rows){
    lines.push(headers.map(h=>esc(r[h])).join(","));
  }
  return lines.join("\n");
}

/* ---------- Download helpers ---------- */
function downloadText(text, filename, mime){
  const blob = new Blob([text], {type: mime || "text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
}
function downloadJson(obj, filename){
  downloadText(JSON.stringify(obj, null, 2), filename, "application/json");
}
function safeDate(d){
  const x = (d && String(d).trim()) ? String(d).trim() : new Date().toISOString().slice(0,10);
  return x.replaceAll("/","-");
}

/* ---------- Init ---------- */
(function init(){
  // If no saved date, set today for convenience (but don't overwrite if user already set)
  const today = new Date().toISOString().slice(0,10);
  if(!state.salesMeta.date) state.salesMeta.date = today;
  if(!state.cash.meta.date) state.cash.meta.date = today;

  // Ensure each item has soldQty
  state.catalog.forEach(it=>{
    if(it.soldQty === undefined) it.soldQty = 0;
    // normalize type fields
    it.type = (it.type === "consigned") ? "consigned" : "owned";
  });

  render();
})();
</script>
</body>
</html>
